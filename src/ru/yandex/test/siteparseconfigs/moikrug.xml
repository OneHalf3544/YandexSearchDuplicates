<?xml version="1.0" encoding="UTF-8"?>

<config charset="UTF-8">

    <include path="functions.xml"/>

    <!-- defines search keyword and start URL -->
    <var-def name="search" overwrite="false">java</var-def>
    <var-def name="outputFile" overwrite="false">vacancy/moikrug.xml</var-def>
    
    <var-def name="baseUrl"><template>http://moikrug.ru</template></var-def>
    <var-def name="url"><template>${baseUrl}/vacancies/?keywords=${search}</template></var-def>
    
    <!-- Собираем ссылки на вакансии -->
    <var-def name="vacancyLinks">
        <call name="download-multipage-list">
            <call-param name="pageUrl"><var name="url"/></call-param>
            <call-param name="nextXPath">//a[@class='next_page']/@href</call-param>
            <call-param name="itemXPath">//div[@class='b-vacancy']/div[@class='title']/a[1]/@href</call-param>
            <call-param name="maxloops">1</call-param>
        </call>
    </var-def>

    <file action="write" path="${outputFile}" charset="UTF-8">
    <![CDATA[ <?xml version="1.0" encoding="UTF-8" ?> ]]>
    <![CDATA[ <vacancies> ]]>
    <template><![CDATA[ <query value="${search}" /> ]]></template>
    
    <loop item="vacancyUrl">
      <list><var name="vacancyLinks"/></list>
      <body>
        <empty>
          <var-def name="content">
            <xpath expression="//div[@id='main']">
              <html-to-xml>
                <http url="${sys.fullUrl(baseUrl.toString(), vacancyUrl.toString())}"/>
              </html-to-xml>
            </xpath>
          </var-def>

          <var-def name="vacUrl"><template>${sys.fullUrl(baseUrl.toString(), vacancyUrl.toString())}</template></var-def>

          <var-def name="vacancyName">
            <xpath expression="//div[@class='title']/span[@class='posotion']/text()">
              <var name="content" />
            </xpath>
          </var-def>

          <var-def name="companyName">
            <xpath expression="//div[@class='advanced_info']/a/text()">
              <var name="content" />
            </xpath>
          </var-def>

          <var-def name="companyUrl">
            <xpath expression="//div[@class='advanced_info']/a/@href">
              <var name="content" />
            </xpath>
          </var-def>

          <!-- Наш плагин, парсящий зарплату  -->
          <salaryparse>
            <xpath expression="//span[@class='salary_label_round']/text()">
              <var name="content" />
            </xpath>
          </salaryparse>

          <var-def name="vacancyCity">
            <xpath expression="//div[@class='advanced']/text()[1]">
              <var name="content" />
            </xpath>
          </var-def>

          <var-def name="description">
            <xpath expression="//div[@class='description text']//text()">
              <var name="content" />
            </xpath>
          </var-def>
          
        </empty>

        <![CDATA[ <vacancy> ]]>

        <template><![CDATA[ <vacancyName url="${sys.escapeXml(vacUrl)}">${sys.escapeXml(vacancyName)}</vacancyName> ]]></template>
        <template><![CDATA[ <companyName companyUrl="${sys.escapeXml(companyUrl)}">${sys.escapeXml(companyName)}</companyName> ]]></template>
        <template><![CDATA[ <salary> ]]></template>
        <template><![CDATA[   <minimum>${salary.getMinimum()}</minimum> ]]></template>
        <template><![CDATA[   <maximum>${salary.getMaximum()}</maximum> ]]></template>
        <template><![CDATA[ </salary> ]]></template>
        <template><![CDATA[ <description> ]]></template>
        <template><![CDATA[   ${sys.escapeXml(description)} ]]></template>
        <template><![CDATA[ </description> ]]></template>
        <template><![CDATA[ <vacancyCity>${sys.escapeXml(vacancyCity)}</vacancyCity> ]]></template>

        <![CDATA[ </vacancy> ]]>
    </body>
  </loop>

  <![CDATA[ </vacancies> ]]>
  </file>

</config>